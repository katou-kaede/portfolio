<div class="container-fluid bg-body-tertiary min-vh-100">
  <div class="row mx-4">
    <h2 class="col-12 my-4">参加イベントカレンダー</h2>
    <%= month_calendar events: @events do |date, events| %>
      <div class="calendar-day">
        <div class="calendar-date">
          <%= date.day %>
        </div>

        <% events.each do |event| %>
          <div>
            <%= link_to event_path(event), class: 'btn btn-warning btn-sm', style: '--bs-btn-padding-y: .1rem; --bs-btn-padding-x: .25rem; --bs-btn-font-size: .75rem;' do %>
              <%= event.date.strftime("%H:%M") %> - <%= event.name %>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
    <% if current_user.uid.present? %>
      <div class="d-flex justify-content-center align-items-center my-3">
        <a href="https://lin.ee/QRxX8g4" class="me-2" target="_blank">
          <img src="https://scdn.line-apps.com/n/line_add_friends/btn/ja.png" alt="友だち追加" height="36" border="0">
        </a>
        <p class="mb-0">イベント前日にLINEでリマインダー通知をお送りします！</p>
      </div>
    <% end %>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // 明日開催予定のイベント情報を取得
    const events = <%= @events.to_json.html_safe %>;

    // イベント情報をGoogle Apps Scriptに送信
    if (events.length > 0) {
      sendEventsToGoogleAppsScript(events);
    }
  });

  function sendEventsToGoogleAppsScript(events) {
    // Google Apps Scriptのエンドポイントを設定
    const url = "https://script.google.com/macros/s/AKfycbxjzuWLndE-WC9ziRfqKhwIWkkrZ4mFGj03LfeztHMpdPq5v3u2DrXEF7TAZuu9QI-f-w/exec";

    // POSTリクエストでイベント情報を送信
    fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        events: events
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log("通知送信結果:", data);
    })
    .catch(error => {
      console.error("エラー:", error);
    });
  }
</script>
